<!DOCTYPE html>
<html>
<head>
    <title>ユーザーページ</title>
    <style>
        body {
            text-align: center; /* ページ全体を中央揃えにする */
        }
        h1, p, h2 {
            text-align: center; /* タイトルやテキストを中央揃えにする */
        }
        table {
            margin: 0 auto; /* テーブルを中央揃えにする */
            text-align: center; /* テーブル内のテキストを中央揃えにする */
        }
        .delete-button {
            display: inline-block; /* 削除ボタンをインラインブロック要素にする */
        }
    </style>
</head>
<body>
    <h1>ユーザーページ</h1>
    <p>{{ username }}さん、こんにちは。</p>

    <!-- タスクの生成フォーム -->
    <h2>新しいタスクを追加</h2>
    <form method="POST" action="{{ url_for('create_task') }}" id="create-task-form">
        <label for="task">タスク:</label>
        <input type="text" id="task" name="task" required>
        <button type="submit">追加</button>
    </form>

    <!-- タスク作成メッセージ -->
    <div id="task-created-message" style="display: none;"></div>

    <!-- タスク一覧 -->
    <h2>タスク一覧</h2>
    <table id="task-list"></table>
    <table>
        <thead>
            <tr>
                <th>タスク名</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr>
                <td>{{ task.description }}</td>
                <td>
                    <form method="POST" action="{{ url_for('delete_task', task_id=task.id) }}" style="display: inline;">
                        <button type="submit" class="delete-button" data-task-id="{{ task.id }}">削除</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- タスク削除成功メッセージ -->
    <div id="delete-task-message" style="display: none;"></div>
    <br>


    <!-- ログアウトボタン -->
    <form method="POST" action="{{ url_for('logout') }}">
        <button type="submit">ログアウト</button>
    </form>

    <script>
        // タスク一覧テーブル
        const taskList = document.getElementById('task-list');
    
        // タスク作成メッセージを取得
        const taskCreatedMessage = document.getElementById('task-created-message');
    
        // タスク削除成功メッセージを取得
        const deleteTaskMessage = document.getElementById('delete-task-message');
    
        // タスク削除ボタンをクリックしたときの処理
        function handleDeleteButtonClick(event) {
            event.preventDefault();
            const button = event.target;
            const taskId = button.getAttribute('data-task-id');
    
            // タスク削除のAPIエンドポイントにリクエストを送信
            fetch(`/delete_task/${taskId}`, {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                // タスク削除成功時の処理
                deleteTaskMessage.textContent = data.message;
                deleteTaskMessage.style.display = 'block';
    
                // タスク一覧を更新
                updateTaskList();
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    
        // タスク削除ボタンにイベントリスナーを追加
        const deleteButtons = document.querySelectorAll('.delete-button');
        deleteButtons.forEach(button => {
            button.addEventListener('click', handleDeleteButtonClick);
        });
    
        // タスク一覧を更新する関数
        function updateTaskList() {
            // タスク一覧をAjaxで取得
            fetch('/get_tasks')
            .then(response => response.json())
            .then(data => {
                // タスク一覧テーブルをクリア
                taskList.innerHTML = '';
    
                // タイトル行を再追加
                taskList.innerHTML = `
                    <tr>
                        <th>タスク名</th>
                        <th>削除</th>
                    </tr>
                `;
    
                // タスクを追加
                data.tasks.forEach(task => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${task.description}</td>
                        <td>
                            <form method="POST" action="/delete_task/${task.id}" style="display: inline;">
                                <button type="submit" class="delete-button" data-task-id="${task.id}">削除</button>
                            </form>
                        </td>
                    `;
                    taskList.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    
        // タスク作成フォームが送信されたときの処理
        document.getElementById('create-task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
    
            // タスクを作成するためのAjaxリクエストを送信
            fetch(form.action, {
                method: form.method,
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'タスクが作成されました') {
                    // タスクが作成されたメッセージを表示
                    taskCreatedMessage.textContent = data.message;
                    taskCreatedMessage.style.display = 'block';
    
                    // タスク一覧を更新
                    updateTaskList();
    
                    // フォームをクリア
                    form.reset();
                } else {
                    // タスク作成に失敗した場合の処理
                    taskCreatedMessage.textContent = 'タスクの作成に失敗しました';
                    taskCreatedMessage.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    
        // ページ読み込み時にタスク一覧を初期化
        updateTaskList();
    </script>
</body>
</html>
